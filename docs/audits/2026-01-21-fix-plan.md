# Production Readiness Fix Plan

**Project:** Aquad'or
**Created:** 2026-01-21
**Target Score:** 72 → 95/100

---

## Phase 1: Critical Blockers (Day 1)

### 1.1 Add Sentry Error Tracking
**Priority:** BLOCKER
**Effort:** 30 min
**Impact:** Observability 20 → 60

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

Files created:
- `sentry.client.config.ts`
- `sentry.server.config.ts`
- `sentry.edge.config.ts`
- `next.config.mjs` (wrapped with withSentryConfig)

Environment variables needed:
```
SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
SENTRY_AUTH_TOKEN=sntrys_xxx
```

### 1.2 Create Health Check Endpoint
**Priority:** BLOCKER
**Effort:** 10 min
**Impact:** Reliability +5

Create `/src/app/api/health/route.ts`:
```typescript
import { NextResponse } from 'next/server';

export async function GET() {
  return NextResponse.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    version: process.env.VERCEL_GIT_COMMIT_SHA?.slice(0, 7) || 'local',
  });
}
```

### 1.3 Add API Timeouts
**Priority:** BLOCKER
**Effort:** 20 min
**Impact:** Reliability +10

**File:** `/src/app/api/checkout/route.ts`
```typescript
// Add at top
const STRIPE_TIMEOUT = 10000; // 10 seconds

// Wrap stripe call
const controller = new AbortController();
const timeout = setTimeout(() => controller.abort(), STRIPE_TIMEOUT);

try {
  const session = await stripe.checkout.sessions.create({...});
  clearTimeout(timeout);
} catch (error) {
  clearTimeout(timeout);
  if (error.name === 'AbortError') {
    return NextResponse.json({ error: 'Payment service timeout' }, { status: 504 });
  }
  throw error;
}
```

**File:** `/src/app/api/contact/route.ts` - Same pattern for Resend

---

## Phase 2: High Priority (Days 2-3)

### 2.1 Add Rate Limiting
**Priority:** HIGH
**Effort:** 45 min
**Impact:** Security +10

```bash
npm install @upstash/ratelimit @upstash/redis
```

Create `/src/lib/rate-limit.ts`:
```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

export const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '1 m'), // 10 requests per minute
  analytics: true,
});

export async function checkRateLimit(identifier: string) {
  const { success, limit, reset, remaining } = await ratelimit.limit(identifier);
  return { success, limit, reset, remaining };
}
```

Apply to routes:
- `/api/checkout` - 5 req/min
- `/api/contact` - 3 req/min
- `/api/create-perfume/payment` - 5 req/min

Environment variables:
```
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxx
```

### 2.2 Static Category Pages
**Priority:** HIGH
**Effort:** 15 min
**Impact:** Performance +5

**File:** `/src/app/shop/[category]/page.tsx`

Convert to Server Component and add:
```typescript
import { categories } from '@/lib/products';

export async function generateStaticParams() {
  return categories.map((cat) => ({ category: cat.slug }));
}

// Remove 'use client' directive
// Move client interactivity to separate component
```

### 2.3 Fix npm Audit Vulnerabilities
**Priority:** HIGH
**Effort:** 10 min
**Impact:** Security +2

```bash
npm audit fix --force
npm run build  # Verify no breaking changes
npm test       # Run tests
```

### 2.4 Add Vercel Analytics
**Priority:** HIGH
**Effort:** 15 min
**Impact:** Observability +15

```bash
npm install @vercel/analytics @vercel/speed-insights
```

**File:** `/src/app/layout.tsx`
```typescript
import { Analytics } from '@vercel/analytics/react';
import { SpeedInsights } from '@vercel/speed-insights/next';

// In body:
<Analytics />
<SpeedInsights />
```

### 2.5 Add Request IDs to API Routes
**Priority:** HIGH
**Effort:** 30 min
**Impact:** Observability +10

Create `/src/middleware.ts`:
```typescript
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(request: NextRequest) {
  const requestId = crypto.randomUUID();
  const response = NextResponse.next();

  response.headers.set('x-request-id', requestId);
  request.headers.set('x-request-id', requestId);

  return response;
}

export const config = {
  matcher: '/api/:path*',
};
```

Update API routes to log with request ID:
```typescript
const requestId = request.headers.get('x-request-id') || 'unknown';
console.log(JSON.stringify({ requestId, event: 'checkout_started', timestamp: Date.now() }));
```

---

## Phase 3: Medium Priority (Days 4-5)

### 3.1 HTML-Escape Email Template
**Priority:** MEDIUM
**Effort:** 15 min
**Impact:** Security +2

**File:** `/src/app/api/contact/route.ts`

```typescript
// Add helper
function escapeHtml(text: string): string {
  return text
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// In email template:
html: `
  <p><strong>Name:</strong> ${escapeHtml(name)}</p>
  <p><strong>Email:</strong> ${escapeHtml(email)}</p>
  ...
`
```

### 3.2 Throttle Scroll Handler
**Priority:** MEDIUM
**Effort:** 10 min
**Impact:** Performance +2

**File:** `/src/components/layout/Navbar.tsx`

```typescript
import { useCallback, useEffect, useState, useRef } from 'react';

export default function Navbar() {
  const [isScrolled, setIsScrolled] = useState(false);
  const ticking = useRef(false);

  useEffect(() => {
    const handleScroll = () => {
      if (!ticking.current) {
        requestAnimationFrame(() => {
          setIsScrolled(window.scrollY > 50);
          ticking.current = false;
        });
        ticking.current = true;
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);
  // ...
}
```

### 3.3 Viewport-Based Animation Pausing
**Priority:** MEDIUM
**Effort:** 20 min
**Impact:** Performance +3

**File:** `/src/components/home/Hero.tsx`

Replace infinite animations with viewport-aware:
```typescript
<motion.div
  initial={{ scale: 1, opacity: 0.3 }}
  whileInView={{
    scale: [1, 1.2, 1],
    opacity: [0.3, 0.5, 0.3],
  }}
  viewport={{ once: false, amount: 0.3 }}
  transition={{ duration: 8, repeat: Infinity }}
/>
```

### 3.4 Conditional Error Details
**Priority:** MEDIUM
**Effort:** 5 min
**Impact:** Security +1

**File:** `/src/app/api/checkout/route.ts`

```typescript
return NextResponse.json(
  {
    error: 'Failed to create checkout session',
    ...(process.env.NODE_ENV === 'development' && {
      message: errorMessage,
      type: errorDetails,
    }),
  },
  { status: 500 }
);
```

### 3.5 Update Privacy Policy with Retention
**Priority:** MEDIUM
**Effort:** 15 min
**Impact:** Privacy/GDPR +3

**File:** `/src/app/privacy/page.tsx`

Add section:
```
## Data Retention

- **Contact form submissions**: Emails retained for 90 days, then automatically deleted
- **Payment records**: Retained by Stripe per their data retention policy (typically 7 years for financial records)
- **Shopping cart**: Stored locally in your browser until you clear your browser data
- **Cookie consent**: Stored locally until you clear your browser data
```

---

## Phase 4: Low Priority (Week 2)

### 4.1 CSP Nonces (Optional Hardening)
**Effort:** 2 hours
**Impact:** Security +2

Requires middleware to generate nonces and pass to components.
Consider after other fixes are deployed.

### 4.2 Structured Logging Service
**Effort:** 1 hour
**Impact:** Observability +5

Options:
- Vercel Logs (free, already available)
- Axiom (free tier)
- Betterstack (free tier)

### 4.3 Uptime Monitoring
**Effort:** 15 min
**Impact:** Reliability +3

Options:
- Vercel's built-in monitoring
- UptimeRobot (free)
- Better Uptime (free tier)

Configure to ping `/api/health` every 5 minutes.

---

## Implementation Order

```
Day 1 (Blockers):
├── 1.1 Sentry (30 min)
├── 1.2 Health check (10 min)
└── 1.3 API timeouts (20 min)

Day 2 (High - Security):
├── 2.1 Rate limiting (45 min)
└── 2.3 npm audit fix (10 min)

Day 3 (High - Performance/Observability):
├── 2.2 Static category pages (15 min)
├── 2.4 Vercel Analytics (15 min)
└── 2.5 Request IDs (30 min)

Day 4 (Medium - Security):
├── 3.1 Email escaping (15 min)
└── 3.4 Error details conditional (5 min)

Day 5 (Medium - Performance/Compliance):
├── 3.2 Scroll throttle (10 min)
├── 3.3 Animation viewport (20 min)
└── 3.5 Privacy policy update (15 min)

Week 2 (Low Priority):
├── 4.1 CSP nonces (optional)
├── 4.2 Logging service
└── 4.3 Uptime monitoring
```

---

## Environment Variables Checklist

Add to Vercel Dashboard → Project Settings → Environment Variables:

```
# Required for Phase 1
SENTRY_DSN=
SENTRY_AUTH_TOKEN=

# Required for Phase 2 (Rate Limiting)
UPSTASH_REDIS_REST_URL=
UPSTASH_REDIS_REST_TOKEN=

# Already configured (verify)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
NEXT_PUBLIC_APP_URL=https://aquadorcy.com
RESEND_API_KEY=
CONTACT_EMAIL_TO=info@aquadorcy.com
```

---

## Verification Checklist

After each phase, verify:

- [ ] `npm run build` succeeds
- [ ] `npm run test` passes
- [ ] `npm run lint` passes
- [ ] Preview deployment works
- [ ] Critical user flows tested:
  - [ ] Browse products
  - [ ] Add to cart
  - [ ] Checkout flow
  - [ ] Contact form
  - [ ] Custom perfume builder

---

## Expected Final Scores

| Category | Before | After |
|----------|--------|-------|
| Security | 78 | 92 |
| Performance | 75 | 85 |
| Reliability | 75 | 90 |
| Observability | 20 | 80 |
| Deployment | 95 | 98 |
| Data/Privacy | 90 | 95 |
| **Overall** | **72** | **90** |
